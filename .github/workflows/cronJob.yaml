name: Cron Job

on:
  push:
  schedule:
    - cron: '0 0 * * *'

jobs:
  fetch_all_pull_request_shas:
    runs-on: ubuntu-latest
    outputs:
      shas: ${{ steps.extract.outputs.shas }}
    steps:
      - name: Extract merge_commit_shas
        shell: bash
        id: extract
        run: |
          pr_infos=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/redhat-developer/lsp4ij/pulls?&state=open&sort=created&direction=desc&per_page=100")
          
          # Extract merge_commit_sha values into an array, excluding draft pull requests
          merge_commit_shas=($(echo "$pr_infos" | jq -r '.[] | select(.draft == false) | .merge_commit_sha'))
          # Create a JSON array string
          shas=$(jq -nc --arg shas "${merge_commit_shas[*]}" '$shas | split(" ")')
          echo "shas=$shas" >> $GITHUB_OUTPUT

  call-build-workflow:
    needs: fetch_all_pull_request_shas
    uses: ./.github/workflows/build.yaml
    strategy:
      matrix:
        sha: ${{ fromJson(needs.fetch_all_pull_request_shas.outputs.shas) }}
    with:
      useLocalPlugin: true
      refLsp4ij: ${{ matrix.sha }}
